#' @include templates.R
NULL

operation_file_template <- template(
  `
  # This file is generated by make.paws. Please do not edit here.
  #' @importFrom paws.common get_config new_operation new_request send_request
  #' @include ${service}_service.R
  NULL

  ${operations}
  `
)

# Make all API operations.
make_operations <- function(api) {
  operations <- lapply(api$operations, function(op) make_operation(op, api))
  render(
    operation_file_template,
    service = package_name(api),
    operations = paste(operations, collapse = "\n\n")
  )
}

# A template for AWS API operations.
operation_template <- template(
  `
  ${docs}
  ${service}_${function_name} <- function(${params}) {
    op <- new_operation(
      name = ${operation_name},
      http_method = ${http_method},
      http_path = ${http_path},
      paginator = list()
    )
    input <- .${service}$${operation_input}
    output <- .${service}$${operation_output}
    config <- get_config()
    svc <- .${service}$service(config)
    request <- new_request(svc, op, input, output)
    response <- send_request(request)
    return(response)
  }
  .${service}$operations$${function_name} <- ${service}_${function_name}
  `
)

# Make an operation, both function and documentation.
make_operation <- function(operation, api) {
  render(
    operation_template,
    docs = make_docs(operation, api),
    service = package_name(api),
    operation_name = quoted(operation$name),
    function_name = get_operation_name(operation),
    params = get_operation_params(get_operation_input_shape(operation, api)),
    operation_input = get_operation_input(operation, api),
    operation_output = get_operation_output(operation),
    http_method = quoted(operation$http$method),
    http_path = quoted(operation$http$requestUri)
  )
}

#-------------------------------------------------------------------------------

get_operation_input <- function(operation, api) {
  input_name <- paste0(get_operation_name(operation), "_input")
  input_shape <- get_operation_input_shape(operation, api)
  make_call(input_name, get_operation_args(input_shape))
}

get_operation_output <- function(operation) {
  output_name <- paste0(get_operation_name(operation), "_output")
  make_call(output_name, c())
}

get_operation_input_shape <- function(operation, api) {
  if ("input" %in% names(operation)) {
    input_shape <- api$shapes[[operation$input$shape]]
  } else {
    input_shape <- list()
  }
  return(input_shape)
}

# Get the inputs for an API operation.
get_inputs <- function(input) {
  if (!is.null(input)) {
    members <- input$members
    required <- unlist(input$required)
    members[] <- lapply(seq_along(members), function(i) {
      x <- members[[i]]
      x$member_name <- names(members)[i]
      x$required <- x$member_name %in% required
      x
    })
  } else {
    members <- list()
  }
  members
}

# Make the list of params that will go in the operation's function signature.
get_operation_params <- function(shape) {
  if (!is.null(shape)) {
    params <- c()
    for (el in get_inputs(shape)) {
      name <- el$member_name
      required <- el$required
      if (required) param <- name
      else param <- sprintf("%s = NULL", name)
      params <- c(params, param)
    }
    result <- paste(params, collapse = ", ")
  } else {
    result <- ""
  }
  return(result)
}

# Make the named list of arguments that will be passed into the operation's
# interface function.
get_operation_args <- function(shape) {
  if (!is.null(shape) && length(shape) > 0) {
    inputs <- get_inputs(shape)
    result <- lapply(inputs, function(x) x$member_name)
  } else {
    result <- list()
  }
  return(result)
}
