#' @include templates.R
#' @include utils.R
NULL

operation_file_template <- template(
  `
  # This file is generated by make.paws. Please do not edit here.
  #' @importFrom paws.common get_config new_operation new_request send_request
  #' @include ${service}_service.R
  NULL

  ${operations}
  `
)

# Make all API operations.
make_operations <- function(api, doc_maker) {
  operations <- lapply(
    api$operations,
    make_operation,
    api = api,
    doc_maker = doc_maker
  )
  render(
    operation_file_template,
    service = package_name(api),
    operations = paste(operations, collapse = "\n\n")
  )
}

# A template for AWS API operations.
operation_template <- template(
  `
  ${docs}
  ${service}_${function_name} <- function(${params}) {
    op <- new_operation(
      name = ${operation_name},
      http_method = ${http_method},
      http_path = ${http_path},
      host_prefix = ${host_prefix},
      paginator = ${paginator},
      stream_api = ${stream_api}
    )
    input <- .${service}$${operation_input}
    output <- .${service}$${operation_output}
    config <- get_config()
    svc <- .${service}$service(config, op)
    request <- new_request(svc, op, input, output)
    response <- send_request(request)
    return(response)
  }
  .${service}$operations$${function_name} <- ${service}_${function_name}
  `
)

# Make an operation, both function and documentation.
make_operation <- function(operation, api, doc_maker) {
  render(
    operation_template,
    docs = doc_maker(operation, api),
    service = package_name(api),
    operation_name = operation_name_override(operation$name),
    function_name = get_operation_name(operation),
    params = get_operation_params(get_operation_input_shape(operation, api)),
    operation_input = get_operation_input(operation, api),
    operation_output = get_operation_output(operation),
    http_method = quoted(operation$http$method),
    http_path = quoted(operation$http$requestUri),
    host_prefix = quoted(operation[["endpoint"]][["hostPrefix"]] %||% ""),
    paginator = set_paginator(operation$paginators),
    stream_api = set_stream_api(operation)
  )
}

set_paginator <- function(paginator) {
  if (!is.null(paginator)) {
    output_token <- paginator$output_token
    if (!is.null(output_token)) {
      for (i in seq_along(output_token)) {
        # output_token[[i]] <- strsplit(output_token[[i]], " ")[[1]][[1]]
        output_token[i] <- list(
          trimws(strsplit(output_token[[i]], split = "||", fixed = T)[[1]])
        )
      }
      paginator$output_token <- unlist(output_token, use.names = FALSE)
      paginator$input_token <- rep_len(
        paginator$input_token,
        length(paginator$output_token)
      )
    }
    paste(trimws(deparse(paginator)), collapse = " ")
  } else {
    "list()"
  }
}

set_stream_api <- function(operation) {
  as.character(operation$eventstream %||% FALSE)
}

# Override operation name from extdata/operation_name_override.yml
operation_name_override <- function(operation_name) {
  path <- system_file(
    "extdata/operation_name_override.yml",
    package = methods::getPackageName()
  )
  out <- yaml::read_yaml(path)
  found <- vapply(
    out,
    function(x) {
      x$name == operation_name
    },
    FUN.VALUE = logical(1)
  )
  override <- NULL
  if (any(found)) {
    override <- out[[which(found)]]$override
  }
  operation_name <- if (!is.null(override)) override else operation_name
  return(quoted(operation_name))
}

#-------------------------------------------------------------------------------

get_operation_input <- function(operation, api) {
  input_name <- paste0(get_operation_name(operation), "_input")
  input_shape <- get_operation_input_shape(operation, api)
  make_call(input_name, get_operation_args(input_shape))
}

get_operation_output <- function(operation) {
  output_name <- paste0(get_operation_name(operation), "_output")
  make_call(output_name, c())
}

get_operation_input_shape <- function(operation, api) {
  if ("input" %in% names(operation)) {
    input_shape <- api$shapes[[operation$input$shape]]
  } else {
    input_shape <- list()
  }
  return(input_shape)
}

# Get the inputs for an API operation.
get_inputs <- function(input) {
  if (!is.null(input)) {
    members <- input$members
    required <- unlist(input$required)
    members[] <- lapply(seq_along(members), function(i) {
      x <- members[[i]]
      x$member_name <- names(members)[i]
      x$required <- x$member_name %in% required
      x
    })
  } else {
    members <- list()
  }
  members
}

# Make the list of params that will go in the operation's function signature.
get_operation_params <- function(shape) {
  if (!is.null(shape)) {
    elements <- get_inputs(shape)
    params <- character(length(elements))
    for (i in seq_along(elements)) {
      name <- elements[[i]]$member_name
      required <- elements[[i]]$required
      if (required) {
        param <- name
      } else {
        param <- sprintf("%s = NULL", name)
      }
      params[[i]] <- param
    }
    result <- paste(params, collapse = ", ")
  } else {
    result <- ""
  }
  return(result)
}

# Make the named list of arguments that will be passed into the operation's
# interface function.
get_operation_args <- function(shape) {
  if (!is.null(shape) && length(shape) > 0) {
    inputs <- get_inputs(shape)
    result <- lapply(inputs, function(x) x$member_name)
  } else {
    result <- list()
  }
  return(result)
}
