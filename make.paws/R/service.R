#' @include templates.R utils.R
NULL

service_file_template <- template(
  `
  # This file is generated by make.paws. Please do not edit here.
  #' @importFrom paws.common new_handlers new_service set_config
  NULL

  #' ${title}
  #'
  #' ${description}
  #'
  #' ${params}
  #'
  #' ${service_syntax}
  #'
  #' ${example}
  #'
  #' ${operations}
  #'
  #' @rdname ${service}
  #' @export
  ${service} <- function(config = list()) {
    svc <- .${service}$operations
    svc <- set_config(svc, config)
    return(svc)
  }

  # Private API objects: metadata, handlers, interfaces, etc.
  .${service} <- list()

  .${service}$operations <- list()

  .${service}$metadata <- list(
    service_name = ${service_name},
    endpoints = ${endpoints},
    service_id = ${service_id},
    api_version = ${api_version},
    signing_name = ${signing_name},
    json_version = ${json_version},
    target_prefix = ${target_prefix}
  )

  .${service}$service <- function(config = list()) {
    handlers <- new_handlers(${protocol}, ${signer})
    new_service(.${service}$metadata, handlers, config)
  }
  `
)

# Returns the service file, which sets up the objects needed to make requests
# to a specific AWS API, e.g. the request handlers and request signer.
make_service <- function(api) {
  render(
    service_file_template,
    title = service_title(api),
    description = service_description(api),
    params = service_params(),
    service_syntax = service_syntax(api),
    example = service_example(api),
    operations = service_operations(api),
    service = package_name(api),
    protocol = protocol_package(api),
    signer = quoted(api$metadata$signatureVersion),
    service_name = quoted(service_name(api)),
    endpoints = endpoints(api),
    service_id = quoted(service_id(api)),
    api_version = api_version(api),
    signing_name = signing_name(api),
    json_version = json_version(api),
    target_prefix = target_prefix(api)
  )
}

#-------------------------------------------------------------------------------

# Return the API title.
service_title <- function(api) {
  api$metadata$serviceFullName
}

# Return the API description.
service_description <- function(api) {
  desc <- convert(api$documentation)
  if (is.null(desc) || desc == "") return("")
  if (length(desc) > 1) {
    if (desc[1] == service_title(api)) desc <- desc[-1]
    if (desc[1] == "") desc <- desc[-1]
  }
  desc <- comment(paste(desc, collapse = "\n"), "#'")
  paste("@description", desc, sep = "\n")
}

# Return the documentation for the parameters to the service function.
service_params <- function() {
  param <- "config"
  param <- comment(paste(param, collapse = "\n"), "#'")
  desc <- "Optional configuration of credentials, endpoint, and/or region."
  desc <- comment(paste(desc, collapse = "\n"), "#'")
  paste("@param", param, desc, sep = "\n")
}

# Return the documentation for the service syntax.
service_syntax <- function(api) {
  section <- "@section Service syntax:"
  service <- package_name(api)
  syntax <- sprintf(
    '```
    svc <- %s(
      config = list(
        credentials = list(
          creds = list(
            access_key_id = "string",
            secret_access_key = "string",
            session_token = "string"
          ),
          profile = "string"
        ),
        endpoint = "string",
        region = "string"
      )
    )
    ```',
    service)
  syntax <- gsub("\n\\s{4}", "\n", syntax)
  syntax <- comment(paste(syntax, collapse = "\n"), "#'")
  paste(section, syntax, sep = "\n")
}

# Returns an example showing how to use the service.
service_example <- function(api) {
  service <- package_name(api)
  example <- make_doc_examples(get_example(api), api)
  example <- gsub("^#' ", "", example) # Delete extra leading Roxygen comment.
  example <- gsub("#' #\\n", "", example) # Delete empty comment.
  find <- "donttest\\{"
  replace <- sprintf("donttest\\{svc <- %s()\n#' ", service)
  gsub(find, replace, example) # Add service client object to the example.
}

# Get the first example, or if none, the first operation without required
# arguments, or if none, the first operation.
get_example <- function(api) {
  for (op in api$operations) {
    if (!is.null(op$examples)) {
      op$examples <- op$examples[1]
      return(op)
    }
  }
  for (op in api$operations) {
    if (!has_required_params(op, api)) {
      op$examples <- list(list(input = list()))
    }
  }
  op <- api$operations[[1]]
  op$examples <- list(list(input = list(Foo = 123)))
  op
}

# Returns a list of the API's operations with links to their docs.
service_operations <- function(api) {
  api_operations <- api$operations
  custom_operations <- get_custom_operations(api)
  operations <- c(api_operations, custom_operations)
  operations <- operations[sort(names(operations))]
  rows <- lapply(operations, function(op) {
    op_name <- get_operation_name(op)
    doc_name <- paste0(package_name(api), "_", op_name)
    data.frame(
      name = link(text = op_name, ref = doc_name),
      desc = get_operation_title(op)
    )
  })
  table <- gsub(" +", " ", tabular(do.call(rbind, rows)))
  table <- comment(table, "#'")
  paste("@section Operations:", table, sep = "\n")
}

# Returns a list of a package's custom operations and their documentation.
get_custom_operations <- function(api) {
  package <- package_name(api)
  from <- system_file(sprintf("src/custom/%s.R", package), package = methods::getPackageName())
  text <- readLines(from)
  operations <- parse_operations(text)
  return(operations)
}

# Returns the standardized protocol name used by an API.
# e.g. rest-json -> restjson.
protocol_package <- function(api) {
  protocol <- api$metadata$protocol
  if (protocol == "json") protocol <- "jsonrpc"
  else if (protocol == "ec2") protocol <- "ec2query"
  else protocol <- gsub("\\-", "", protocol)
  quoted(protocol)
}

# Returns the signing name for an API, either the signing name specified in the
# API definition or the signing name assigned by `client_config`.
signing_name <- function(api) {
  name <- api$metadata$signingName
  if (is.null(name)) return("NULL")
  quoted(name)
}

# Returns a string representation of a list of the endpoints or endpoint
# patterns, e.g. "list("*/*" = "{service}.{region}.amazonaws.com")".
endpoints <- function(api) {
  get_structure(api$region_config)
}

# Returns the API's version, or "" if none.
api_version <- function(api) {
  version <- api$metadata$apiVersion
  if (is.null(version)) version <- ""
  quoted(version)
}

# Returns the JSON version for the API, or "" if none.
json_version <- function(api) {
  version <- api$metadata$jsonVersion
  if (is.null(version)) version <- ""
  quoted(version)
}

# Returns the target prefix for the API, or "" if none.
target_prefix <- function(api) {
  prefix <- api$metadata$targetPrefix
  if (is.null(prefix)) prefix <- ""
  quoted(prefix)
}
