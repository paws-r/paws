#' @include templates.R utils.R
NULL

service_file_template <- template(
  `
  # This file is generated by make.paws. Please do not edit here.
  #' @importFrom paws.common new_handlers new_service set_config merge_config
  NULL

  #' ${title}
  #'
  #' ${description}
  #'
  #' ${params}
  #'
  #' ${service_syntax}
  #'
  #' ${example}
  #'
  #' ${operations}
  #'
  #' ${return}
  #'
  #' @rdname ${service}
  #' @export
  ${service} <- function(config = list(), credentials = list(), endpoint = NULL, region = NULL) {
    config <- merge_config(
      config,
      list(
        credentials = credentials,
        endpoint = endpoint,
        region = region
      )
    )
    svc <- .${service}$operations
    svc <- set_config(svc, config)
    return(svc)
  }

  # Private API objects: metadata, handlers, interfaces, etc.
  .${service} <- list()

  .${service}$operations <- list()

  .${service}$metadata <- list(
    service_name = ${service_name},
    endpoints = ${endpoints},
    service_id = ${service_id},
    api_version = ${api_version},
    signing_name = ${signing_name},
    json_version = ${json_version},
    target_prefix = ${target_prefix}
  )

  .${service}$service <- function(config = list(), op = NULL) {
    handlers <- new_handlers(${protocol}, ${signer})
    new_service(.${service}$metadata, handlers, config, op)
  }
  `
)

# Returns the service file, which sets up the objects needed to make requests
# to a specific AWS API, e.g. the request handlers and request signer.
make_service <- function(api) {
  render(
    service_file_template,
    title = service_title(api),
    description = service_description(api),
    params = service_params(),
    service_syntax = service_syntax(api),
    example = service_example(api),
    operations = service_operations(api),
    return = service_return(api),
    service = package_name(api),
    protocol = protocol_package(api),
    signer = quoted(api$metadata$signatureVersion),
    service_name = quoted(service_name(api)),
    endpoints = endpoints(api),
    service_id = quoted(service_id(api)),
    api_version = api_version(api),
    signing_name = signing_name(api),
    json_version = json_version(api),
    target_prefix = target_prefix(api)
  )
}

#-------------------------------------------------------------------------------

# Return the API title.
service_title <- function(api) {
  api$metadata$serviceFullName
}

# Return the API description.
service_description <- function(api) {
  desc <- convert(api$documentation, package_name(api), links = get_links(api))
  if (is.null(desc) || length(desc) == 0 || (length(desc) == 1 && desc == "")) {
    return("")
  }
  if (length(desc) > 1) {
    if (desc[1] == service_title(api)) {
      desc <- desc[-1]
    }
    if (desc[1] == "") desc <- desc[-1]
  }
  desc <- comment(paste(desc, collapse = "\n"), "#'")
  paste("@description", desc, sep = "\n")
}

# Return the documentation for the parameters to the service function.
service_params <- function() {
  param <- comment(paste("config", collapse = "\n"), "#'")
  desc <- "Optional configuration of credentials, endpoint, and/or region."
  config <- list(
    credentials = list(
      creds = list(
        access_key_id = "AWS access key ID",
        secret_access_key = "AWS secret access key",
        session_token = "AWS temporary session token"
      ),
      profile = paste(
        "The name of a profile to use. If not given, then the default profile",
        "is used."
      ),
      anonymous = "Set anonymous credentials."
    ),
    endpoint = "The complete URL to use for the constructed client.",
    region = "The AWS Region used in instantiating the client.",
    close_connection = "Immediately close all HTTP connections.",
    timeout = paste(
      "The time in seconds till a timeout exception is thrown when attempting",
      "to make a connection. The default is 60 seconds."
    ),
    s3_force_path_style = paste(
      "Set this to `true` to force the request to use path-style addressing,",
      "i.e. `http://s3.amazonaws.com/BUCKET/KEY`."
    ),
    sts_regional_endpoint = paste(
      "Set sts regional endpoint resolver to regional or legacy",
      "\\url{https://docs.aws.amazon.com/sdkref/latest/guide/feature-sts-regionalized-endpoints.html}"
    )
  )
  desc <- c(desc, comment_list_itemize(config))
  desc <- comment(paste(desc, collapse = "\n"), "#'")
  param <- paste("@param", param, desc, sep = "\n")

  kwargs <- comment(paste("credentials", collapse = "\n"), "#'")
  desc <- "Optional credentials shorthand for the config parameter"
  credentials <- list(
    creds = list(
      access_key_id = "AWS access key ID",
      secret_access_key = "AWS secret access key",
      session_token = "AWS temporary session token"
    ),
    profile = paste(
      "The name of a profile to use. If not given, then the default profile",
      "is used."
    ),
    anonymous = "Set anonymous credentials."
  )
  desc <- c(desc, comment_list_itemize(credentials))
  desc <- comment(paste(desc, collapse = "\n"), "#'")
  param <- paste(param, "#' @param", kwargs, desc, sep = "\n")

  endpoint <- comment(paste("endpoint", collapse = "\n"), "#'")
  desc <- "Optional shorthand for complete URL to use for the constructed client."
  desc <- comment(paste(desc, collapse = "\n"), "#'")
  param <- paste(param, "#' @param", endpoint, desc, sep = "\n")

  region <- comment(paste("region", collapse = "\n"), "#'")
  desc <- "Optional shorthand for AWS Region used in instantiating the client."
  desc <- comment(paste(desc, collapse = "\n"), "#'")
  return(paste(param, "#' @param", region, desc, sep = "\n"))
}

# Return the documentation for the service syntax.
service_syntax <- function(api) {
  section <- "@section Service syntax:"
  service <- package_name(api)
  syntax <- sprintf(
    '```
    svc <- %s(
      config = list(
        credentials = list(
          creds = list(
            access_key_id = "string",
            secret_access_key = "string",
            session_token = "string"
          ),
          profile = "string",
          anonymous = "logical"
        ),
        endpoint = "string",
        region = "string",
        close_connection = "logical",
        timeout = "numeric",
        s3_force_path_style = "logical",
        sts_regional_endpoint = "string"
      ),
      credentials = list(
        creds = list(
          access_key_id = "string",
          secret_access_key = "string",
          session_token = "string"
        ),
        profile = "string",
        anonymous = "logical"
      ),
      endpoint = "string",
      region = "string"
    )
    ```',
    service
  )
  syntax <- gsub("\n\\s{4}", "\n", syntax)
  syntax <- comment(paste(syntax, collapse = "\n"), "#'")
  paste(section, syntax, sep = "\n")
}

# Returns an example showing how to use the service.
service_example <- function(api) {
  service <- package_name(api)
  example <- make_doc_examples(get_example(api), api)
  example <- gsub("^#' ", "", example) # Delete extra leading Roxygen comment.
  example <- gsub("#' #\\n", "", example) # Delete empty comment.
  find <- "dontrun\\{\n"
  replace <- sprintf("dontrun\\{\n#' svc <- %s()\n", service)
  gsub(find, replace, example) # Add service client object to the example.
}

# Get the first example, or if none, the first operation without required
# arguments, or if none, the first operation.
get_example <- function(api) {
  for (op in api$operations) {
    if (!is.null(op$examples)) {
      op$examples <- op$examples[1]
      return(op)
    }
  }
  for (op in api$operations) {
    if (!has_required_params(op, api)) {
      op$examples <- list(list(input = list()))
    }
  }
  op <- api$operations[[1]]
  op$examples <- list(list(input = list(Foo = 123)))
  op
}

# Returns a list of the API's operations with links to their docs.
service_operations <- function(api) {
  api_operations <- api$operations
  custom_operations <- get_custom_operations(api)
  operations <- c(api_operations, custom_operations)
  operations <- operations[sort(names(operations))]
  rows <- lapply(operations, function(op) {
    op_name <- get_operation_name(op)
    doc_name <- paste0(package_name(api), "_", op_name)
    data.frame(
      name = link(text = op_name, ref = doc_name),
      desc = get_operation_title(op)
    )
  })
  table <- gsub(" +", " ", tabular(do.call(rbind, rows)))
  table <- comment(table, "#'")
  paste("@section Operations:", table, sep = "\n")
}

# Returns a list of a package's custom operations and their documentation.
get_custom_operations <- function(api) {
  package <- package_name(api)
  from <- system_file(
    sprintf("src/custom/%s.R", package),
    package = methods::getPackageName()
  )
  if (from == "") {
    return(list())
  }
  text <- readLines(from)
  operations <- parse_operations(text)
  return(operations)
}

service_return <- function(api) {
  text <- c(
    "A client for the service. You can call the service's operations using",
    "syntax like `svc$operation(...)`, where `svc` is the name you've assigned",
    "to the client. The available operations are listed in the",
    "Operations section."
  )
  text <- comment(paste(text, collapse = "\n"), "#'")
  paste("@return", text, sep = "\n")
}

# Returns the standardized protocol name used by an API.
# e.g. rest-json -> restjson.
protocol_package <- function(api) {
  protocol <- api$metadata$protocol
  if (protocol == "json") {
    protocol <- "jsonrpc"
  } else if (protocol == "ec2") {
    protocol <- "ec2query"
  } else {
    protocol <- gsub("\\-", "", protocol)
  }
  quoted(protocol)
}

# Returns the signing name for an API as specified in the API definition. If
# none exists, return NULL; in this case, the signing name will be inferred at
# run time.
signing_name <- function(api) {
  name <- api$metadata$signingName
  if (is.null(name)) {
    name <- api$metadata$endpointPrefix
  }
  if (is.null(name)) {
    return("NULL")
  }
  quoted(name)
}

# Returns a string representation of a list of the endpoints or endpoint
# patterns, e.g. "list("*/*" = "{service}.{region}.amazonaws.com")".
endpoints <- function(api) {
  get_structure(api$region_config)
}

# Returns the API's version, or "" if none.
api_version <- function(api) {
  version <- api$metadata$apiVersion
  if (is.null(version)) {
    version <- ""
  }
  quoted(version)
}

# Returns the JSON version for the API, or "" if none.
json_version <- function(api) {
  version <- api$metadata$jsonVersion
  if (is.null(version)) {
    version <- ""
  }
  quoted(version)
}

# Returns the target prefix for the API, or "" if none.
target_prefix <- function(api) {
  prefix <- api$metadata$targetPrefix
  if (is.null(prefix)) {
    prefix <- ""
  }
  quoted(prefix)
}
