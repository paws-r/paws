#' @include templates.R
NULL

service_file_template <- template(
  `
  # This file is generated by make.paws. Please do not edit here.
  #' @importFrom paws.common new_handlers new_service
  NULL

  #' ${title}
  #'
  #' ${description}
  #'
  #' ${operations}
  #'
  #' @usage
  #' ${service} <- paws::${service}
  #' ${service}$operation()
  #'
  #' @rdname ${service}
  #' @export
  ${service} <- function() {
    .${service}$operations
  }

  # Private API objects: metadata, handlers, interfaces, etc.
  .${service} <- list()

  .${service}$operations <- list()

  .${service}$metadata <- list(
    service_name = ${service_name},
    endpoints = ${endpoints},
    service_id = ${service_id},
    api_version = ${api_version},
    signing_name = ${signing_name},
    json_version = ${json_version},
    target_prefix = ${target_prefix}
  )

  .${service}$handlers <- new_handlers(${protocol}, ${signer})

  .${service}$service <- function() {
    new_service(.${service}$metadata, .${service}$handlers)
  }
  `
)

# Returns the service file which sets up the objects needed to make requests to
# a specific AWS API, e.g. the request handlers and request signer.
make_service <- function(api) {
  render(
    service_file_template,
    title = service_title(api),
    description = service_description(api),
    operations = service_operations(api),
    service = package_name(api),
    protocol = protocol_package(api),
    signer = quoted(api$metadata$signatureVersion),
    service_name = quoted(service_name(api)),
    endpoints = endpoints(api),
    service_id = quoted(service_id(api)),
    api_version = api_version(api),
    signing_name = signing_name(api),
    json_version = json_version(api),
    target_prefix = target_prefix(api)
  )
}

#-------------------------------------------------------------------------------

# Return the API title.
service_title <- function(api) {
  api$metadata$serviceFullName
}

# Return the API description.
service_description <- function(api) {
  desc <- convert(api$documentation)
  if (is.null(desc) || desc == "") return("")
  if (length(desc) > 1) {
    if (desc[1] == service_title(api)) desc <- desc[-1]
    if (desc[1] == "") desc <- desc[-1]
  }
  desc <- comment(desc, "#'")
  paste("@description", desc, sep = "\n")
}

# Returns a list of the API's operations with links to their docs.
service_operations <- function(api) {
  rows <- lapply(api$operations, function(op) {
    op_name <- get_operation_name(op)
    doc_name <- paste0(package_name(api), "_", op_name)
    data.frame(
      name = link(text = op_name, ref = doc_name),
      desc = get_operation_title(op)
    )
  })
  table <- gsub(" +", " ", tabular(do.call(rbind, rows)))
  table <- comment(table, "#'")
  paste("@section Operations:", table, sep = "\n")
}

# Returns the standardized protocol name used by an API.
# e.g. rest-json -> restjson.
protocol_package <- function(api) {
  protocol <- api$metadata$protocol
  if (protocol == "json") protocol <- "jsonrpc"
  else if (protocol == "ec2") protocol <- "ec2query"
  else protocol <- gsub("\\-", "", protocol)
  quoted(protocol)
}

# Returns the signing name for an API, either the signing name specified in the
# API definition or the signing name assigned by `client_config`.
signing_name <- function(api) {
  name <- api$metadata$signingName
  if (is.null(name)) return("NULL")
  quoted(name)
}

# Returns a string representation of a list of the endpoints or endpoint
# patterns, e.g. "list("*/*" = "{service}.{region}.amazonaws.com")".
endpoints <- function(api) {
  get_structure(api$region_config)
}

# Returns the API's version, or "" if none.
api_version <- function(api) {
  version <- api$metadata$apiVersion
  if (is.null(version)) version <- ""
  quoted(version)
}

# Returns the JSON version for the API, or "" if none.
json_version <- function(api) {
  version <- api$metadata$jsonVersion
  if (is.null(version)) version <- ""
  quoted(version)
}

# Returns the target prefix for the API, or "" if none.
target_prefix <- function(api) {
  prefix <- api$metadata$targetPrefix
  if (is.null(prefix)) prefix <- ""
  quoted(prefix)
}
